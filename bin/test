#!/bin/bash

# Test runner script for Meeting Markdown Export Plugin
# This script runs tests in the Docker environment using the base OpenProject setup

set -e

# Get the directory of this script
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# PROJECT_ROOT should be the OpenProject root directory
# From plugins/openproject-meeting-markdown-export/bin/test, go up 3 levels to reach project root
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../../.." && pwd)"

# Set default UID/GID if not provided (for Docker build)
export DEV_UID="${DEV_UID:-$(id -u)}"
export DEV_GID="${DEV_GID:-$(id -g)}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print colored messages
print_info() {
    echo -e "${GREEN}$1${NC}"
}

print_error() {
    echo -e "${RED}$1${NC}"
}

print_warning() {
    echo -e "${YELLOW}$1${NC}"
}

# Function to show usage
show_usage() {
    cat << EOF
Usage: $0 [command] [options]

Commands:
    setup       - Setup test environment (run once)
    unit         - Run unit tests only
    integration  - Run integration tests only
    feature      - Run feature tests (requires selenium)
    all          - Run all tests
    clean        - Clean up Docker containers and volumes
    help         - Show this help message

Options:
    --verbose     - Enable verbose output
    --fast        - Skip slow tests
    --focus FILE  - Run only specific test file

Examples:
    $0 setup
    $0 unit
    $0 feature --verbose
    $0 all --focus spec/workers/meetings/markdown_exporter_spec.rb

EOF
}

# Default values
VERBOSE=false
FAST=false
FOCUS_FILE=""

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        setup|unit|integration|feature|all|clean|help)
            COMMAND=$1
            shift
            ;;
        --verbose)
            VERBOSE=true
            shift
            ;;
        --fast)
            FAST=true
            shift
            ;;
        --focus)
            FOCUS_FILE="$2"
            shift 2
            ;;
        *)
            print_error "Unknown option: $1"
            show_usage
            exit 1
            ;;
    esac
done

# Show help if no command or help command
if [[ -z "$COMMAND" ]] || [[ "$COMMAND" == "help" ]]; then
    show_usage
    exit 0
fi

# Change to project root
cd "$PROJECT_ROOT"

# Check if docker-compose is available
if ! command -v docker-compose &> /dev/null && ! docker compose version &> /dev/null; then
    print_error "Docker Compose is not installed or not available"
    exit 1
fi

# Determine docker-compose command - use the base docker-compose.yml with override
PLUGIN_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
if command -v docker-compose &> /dev/null; then
    DOCKER_COMPOSE="docker-compose -f docker-compose.yml -f $PLUGIN_DIR/docker-compose.override.yml"
else
    DOCKER_COMPOSE="docker compose -f docker-compose.yml -f $PLUGIN_DIR/docker-compose.override.yml"
fi

# Function to setup test environment
setup_environment() {
    print_info "Setting up test environment..."
    
    # Start test containers using base docker-compose.yml with override
    # Note: frontend-test is not started for unit tests (removed in override)
    $DOCKER_COMPOSE up -d --no-deps db-test selenium-hub cuprite-chrome
    
    # Wait for selenium hub to be ready
    print_info "Waiting for Selenium hub..."
    while ! curl -sSL http://localhost:4444/wd/hub/status 2>&1 | grep -q "ready"; do
        sleep 1
        echo -n "."
    done
    echo ""
    
    # Run database migrations
    print_info "Running database migrations..."
    $DOCKER_COMPOSE run --rm backend-test bundle exec rake db:migrate RAILS_ENV=test
    
    print_info "Setup complete!"
}

# Function to run tests
run_tests() {
    local test_type=$1
    local rspec_args=""
    
    # Build rspec arguments
    if [[ "$VERBOSE" == "true" ]]; then
        rspec_args="$rspec_args --format documentation"
    fi
    
    if [[ "$FAST" == "true" ]]; then
        rspec_args="$rspec_args --tag ~slow"
    fi
    
    if [[ -n "$FOCUS_FILE" ]]; then
        rspec_args="$rspec_args plugins/openproject-meeting-markdown-export/$FOCUS_FILE"
    else
        rspec_args="$rspec_args plugins/openproject-meeting-markdown-export/spec"
    fi
    
    # Run tests based on type
    case $test_type in
        unit)
            print_info "Running unit tests..."
            rspec_args="$rspec_args --tag ~feature --tag ~integration"
            ;;
        integration)
            print_info "Running integration tests..."
            rspec_args="$rspec_args --tag ~feature --tag ~unit"
            ;;
        feature)
            print_info "Running feature tests..."
            rspec_args="$rspec_args --tag feature"
            # For feature tests, we need the frontend - start it if not running
            if ! $DOCKER_COMPOSE ps frontend-test | grep -q "Up"; then
                print_info "Starting frontend-test for feature tests..."
                $DOCKER_COMPOSE up -d frontend-test
                # Wait for frontend to be healthy
                print_info "Waiting for frontend to be ready..."
                while ! $DOCKER_COMPOSE ps frontend-test | grep -q "healthy"; do
                    sleep 1
                    echo -n "."
                done
                echo ""
            fi
            ;;
        all)
            print_info "Running all tests..."
            ;;
    esac
    
    # Start backend-test if not running
    if ! $DOCKER_COMPOSE ps backend-test | grep -q "Up"; then
        print_info "Starting backend-test container..."
        # Start backend-test without dependencies
        $DOCKER_COMPOSE up -d --no-deps backend-test
        
        # Wait for backend to be ready
        print_info "Waiting for backend to be ready..."
        while ! $DOCKER_COMPOSE logs backend-test 2>&1 | grep -q "Ready for tests"; do
            sleep 1
            echo -n "."
        done
        echo ""
    fi
    
    # Run tests
    print_info "Executing: bundle exec rspec $rspec_args"
    $DOCKER_COMPOSE exec backend-test bundle exec rspec $rspec_args
}

# Function to clean up
clean_up() {
    print_info "Cleaning up Docker containers and volumes..."
    $DOCKER_COMPOSE down -v
    print_info "Cleanup complete!"
}

# Execute command
case $COMMAND in
    setup)
        setup_environment
        ;;
    unit)
        run_tests unit
        ;;
    integration)
        run_tests integration
        ;;
    feature)
        run_tests feature
        ;;
    all)
        run_tests all
        ;;
    clean)
        clean_up
        ;;
esac
